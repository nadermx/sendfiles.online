{% extends "base.html" %}

{% block title %}Preview: {{ file.original_name }} - SendFiles.Online{% endblock %}
{% block description %}Preview file from SendFiles.Online transfer.{% endblock %}

{% block extra_head %}
<!-- Highlight.js for code syntax highlighting -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/vs2015.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
{% endblock %}

{% block content %}
<div class="preview-page">
    <!-- Navigation Header -->
    <div class="preview-nav">
        <a href="{% url 'download_page' short_id=transfer.short_id %}" class="back-btn">
            <i class="fas fa-arrow-left"></i> Back to files
        </a>
        <span class="preview-counter">{{ current_index }} of {{ total_files }}</span>
        <div class="nav-arrows">
            {% if prev_file %}
            <a href="{% url 'preview_file' short_id=transfer.short_id file_id=prev_file.id %}" class="nav-btn">
                <i class="fas fa-chevron-left"></i>
            </a>
            {% else %}
            <span class="nav-btn disabled"><i class="fas fa-chevron-left"></i></span>
            {% endif %}
            {% if next_file %}
            <a href="{% url 'preview_file' short_id=transfer.short_id file_id=next_file.id %}" class="nav-btn">
                <i class="fas fa-chevron-right"></i>
            </a>
            {% else %}
            <span class="nav-btn disabled"><i class="fas fa-chevron-right"></i></span>
            {% endif %}
        </div>
    </div>

    <!-- File Info -->
    <div class="preview-info">
        <i class="fas fa-{{ file.get_icon_class }} me-2"></i>
        <span class="file-name">{{ file.original_name }}</span>
        <span class="file-size">{{ file.format_size }}</span>
    </div>

    <!-- Preview Content -->
    <div class="preview-container">
        {% if file.preview_type == 'image' %}
        <div class="preview-image">
            <img src="{% url 'raw_file' short_id=transfer.short_id file_id=file.id %}" alt="{{ file.original_name }}" />
        </div>

        {% elif file.preview_type == 'video' %}
        <div class="preview-video">
            <video controls autoplay>
                <source src="{% url 'raw_file' short_id=transfer.short_id file_id=file.id %}" type="{{ file.mime_type }}">
                Your browser does not support the video tag.
            </video>
        </div>

        {% elif file.preview_type == 'audio' %}
        <div class="preview-audio">
            <div class="audio-icon">
                <i class="fas fa-music"></i>
            </div>
            <audio controls autoplay>
                <source src="{% url 'raw_file' short_id=transfer.short_id file_id=file.id %}" type="{{ file.mime_type }}">
                Your browser does not support the audio element.
            </audio>
        </div>

        {% elif file.preview_type == 'pdf' %}
        <div class="preview-pdf">
            <iframe src="{% url 'raw_file' short_id=transfer.short_id file_id=file.id %}#toolbar=1&navpanes=0"></iframe>
        </div>

        {% elif file.preview_type == 'text' %}
        <div class="preview-text">
            <pre id="codeContent"><code class="language-{{ file.get_code_language }}">Loading...</code></pre>
        </div>
        <script>
            fetch("{% url 'raw_file' short_id=transfer.short_id file_id=file.id %}")
                .then(response => response.text())
                .then(text => {
                    const codeEl = document.querySelector('#codeContent code');
                    codeEl.textContent = text;
                    // Apply syntax highlighting
                    if (typeof hljs !== 'undefined') {
                        hljs.highlightElement(codeEl);
                    }
                })
                .catch(() => {
                    document.querySelector('#codeContent code').textContent = 'Unable to load file content';
                });
        </script>

        {% else %}
        <div class="preview-unavailable">
            <i class="fas fa-file fa-4x mb-3 text-muted"></i>
            <p>Preview not available for this file type</p>
        </div>
        {% endif %}
    </div>

    <!-- Actions -->
    <div class="preview-actions">
        <a href="{% url 'download_file' short_id=transfer.short_id file_id=file.id %}" class="btn btn-primary btn-lg">
            <i class="fas fa-download me-2"></i> Download {{ file.format_size }}
        </a>
    </div>
</div>

<style>
.preview-page {
    min-height: calc(100vh - 200px);
    display: flex;
    flex-direction: column;
}

/* Navigation */
.preview-nav {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background: var(--gray-100);
    border-bottom: 1px solid var(--gray-200);
}
.back-btn {
    color: var(--gray-700);
    text-decoration: none;
}
.back-btn:hover {
    color: var(--gray-900);
}
.preview-counter {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.9rem;
    color: var(--gray-500);
}
.nav-arrows {
    display: flex;
    gap: 5px;
}
.nav-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    background: var(--gray-200);
    color: var(--gray-700);
    text-decoration: none;
}
.nav-btn:hover {
    background: var(--gray-300);
    color: var(--gray-900);
}
.nav-btn.disabled {
    opacity: 0.3;
    pointer-events: none;
}

/* File info */
.preview-info {
    padding: 15px 20px;
    background: var(--gray-50);
    border-bottom: 1px solid var(--gray-200);
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 10px;
}
.preview-info .file-name {
    font-weight: 500;
    word-break: break-all;
}
.preview-info .file-size {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
    color: var(--gray-500);
    margin-left: auto;
}

/* Preview container */
.preview-container {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
    background: var(--gray-900);
    min-height: 400px;
}

/* Image preview */
.preview-image {
    max-width: 100%;
    max-height: calc(100vh - 350px);
}
.preview-image img {
    max-width: 100%;
    max-height: calc(100vh - 350px);
    object-fit: contain;
}

/* Video preview */
.preview-video {
    width: 100%;
    max-width: 1000px;
}
.preview-video video {
    width: 100%;
    max-height: calc(100vh - 350px);
}

/* Audio preview */
.preview-audio {
    text-align: center;
    width: 100%;
    max-width: 500px;
}
.preview-audio .audio-icon {
    font-size: 80px;
    color: var(--gray-500);
    margin-bottom: 30px;
}
.preview-audio audio {
    width: 100%;
}

/* PDF preview */
.preview-pdf {
    width: 100%;
    height: calc(100vh - 350px);
    min-height: 500px;
}
.preview-pdf iframe {
    width: 100%;
    height: 100%;
    border: none;
    background: #fff;
}

/* Text/Code preview */
.preview-text {
    width: 100%;
    height: calc(100vh - 350px);
    min-height: 400px;
    overflow: auto;
}
.preview-text pre {
    width: 100%;
    min-height: 100%;
    margin: 0;
    padding: 20px;
    background: #1e1e1e;
    color: #d4d4d4;
    font-family: 'JetBrains Mono', monospace;
    font-size: 14px;
    line-height: 1.5;
    text-align: left;
}

/* Preview unavailable */
.preview-unavailable {
    text-align: center;
    color: var(--gray-400);
}

/* Actions */
.preview-actions {
    padding: 20px;
    text-align: center;
    background: var(--gray-100);
    border-top: 1px solid var(--gray-200);
}

/* Keyboard navigation */
@media (min-width: 768px) {
    .preview-page {
        min-height: calc(100vh - 150px);
    }
}
</style>

<script>
// Keyboard navigation
document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft') {
        const prevLink = document.querySelector('.nav-btn:not(.disabled)[href*="preview"]');
        if (prevLink) window.location.href = prevLink.href;
    } else if (e.key === 'ArrowRight') {
        const navBtns = document.querySelectorAll('.nav-btn:not(.disabled)[href*="preview"]');
        if (navBtns.length > 1) window.location.href = navBtns[1].href;
        else if (navBtns.length === 1) {
            // Check if it's the next button (second in DOM)
            const nextLink = document.querySelectorAll('.nav-arrows .nav-btn')[1];
            if (nextLink && !nextLink.classList.contains('disabled')) {
                window.location.href = nextLink.href;
            }
        }
    } else if (e.key === 'Escape') {
        window.location.href = "{% url 'download_page' short_id=transfer.short_id %}";
    }
});
</script>
{% endblock %}
