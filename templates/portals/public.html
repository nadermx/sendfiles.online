{% extends "base.html" %}

{% block title %}{{ portal.name }} - Upload Files{% endblock %}
{% block description %}Upload files to {{ portal.name }} via SendFiles.Online.{% endblock %}

{% block breadcrumbs %}{% endblock %}

{% block content %}
<div class="portal-page" style="{% if portal.primary_color %}--portal-color: {{ portal.primary_color }};{% endif %}">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <!-- Portal Header -->
                <div class="text-center mb-4">
                    {% if portal.logo %}
                    <img src="{{ portal.logo }}" alt="{{ portal.name }}" class="portal-logo mb-3" style="max-height: 80px;">
                    {% endif %}
                    <h1 class="h2 mb-2">{{ portal.name }}</h1>
                    {% if portal.description %}
                    <p class="text-muted">{{ portal.description }}</p>
                    {% endif %}
                </div>

                {% if portal.welcome_message %}
                <div class="alert alert-light mb-4" style="border-left: 4px solid var(--portal-color, #111);">
                    {{ portal.welcome_message }}
                </div>
                {% endif %}

                <!-- Upload Zone -->
                <div id="upload-zone" class="upload-zone">
                    <h2>DROP FILES HERE OR CLICK TO BROWSE</h2>
                    <p>Maximum {{ portal.max_file_size|filesizeformat }} per file</p>
                    <input type="file" id="file-input" multiple style="display: none;">
                </div>

                <!-- File List -->
                <div id="file-list" class="mt-4" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span id="file-count" class="font-mono">0 files</span>
                        <span id="total-size" class="font-mono text-muted">0 KB</span>
                    </div>
                    <div id="files-container"></div>
                </div>

                <!-- Uploader Info -->
                <div id="info-section" class="mt-4" style="display: none;">
                    <div class="card">
                        <div class="card-body">
                            <div class="row g-3">
                                {% if portal.require_email or portal.require_name %}
                                {% if portal.require_name %}
                                <div class="col-md-6">
                                    <label for="uploader-name" class="form-label">Your Name{% if portal.require_name %} <span class="text-danger">*</span>{% endif %}</label>
                                    <input type="text" class="form-control" id="uploader-name" {% if portal.require_name %}required{% endif %}>
                                </div>
                                {% endif %}
                                <div class="{% if portal.require_name %}col-md-6{% else %}col-12{% endif %}">
                                    <label for="uploader-email" class="form-label">Your Email{% if portal.require_email %} <span class="text-danger">*</span>{% endif %}</label>
                                    <input type="email" class="form-control" id="uploader-email" {% if portal.require_email %}required{% endif %}>
                                </div>
                                {% else %}
                                <div class="col-md-6">
                                    <label for="uploader-name" class="form-label">Your Name (optional)</label>
                                    <input type="text" class="form-control" id="uploader-name">
                                </div>
                                <div class="col-md-6">
                                    <label for="uploader-email" class="form-label">Your Email (optional)</label>
                                    <input type="email" class="form-control" id="uploader-email">
                                </div>
                                {% endif %}
                                <div class="col-12">
                                    <label for="message" class="form-label">Message (optional)</label>
                                    <textarea class="form-control" id="message" rows="2" placeholder="Add a message..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Button -->
                <div id="upload-button-section" class="mt-4 text-center" style="display: none;">
                    <button id="upload-btn" class="btn btn-primary btn-lg" style="background-color: var(--portal-color, #111); border-color: var(--portal-color, #111);">
                        UPLOAD FILES
                    </button>
                </div>

                <!-- Progress -->
                <div id="progress-section" class="mt-4" style="display: none;">
                    <div class="text-center mb-3">
                        <span id="upload-status" class="font-mono">Uploading...</span>
                    </div>
                    <div class="progress">
                        <div id="upload-progress" class="progress-bar" role="progressbar" style="width: 0%; background-color: var(--portal-color, #111);"></div>
                    </div>
                </div>

                <!-- Success -->
                <div id="success-section" class="mt-4 text-center" style="display: none;">
                    <div style="font-size: 4rem; color: var(--success);">&#10003;</div>
                    <h2 class="h4 mb-3">Upload Complete!</h2>
                    <p class="text-muted">Your files have been sent successfully.</p>
                    <button class="btn btn-outline-primary" onclick="resetUpload()">Upload More Files</button>
                </div>

                <!-- Powered By -->
                <div class="text-center mt-5">
                    <small class="text-muted">
                        Powered by <a href="/" class="text-muted">SendFiles.Online</a>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.portal-page {
    --portal-color: {{ portal.primary_color|default:'#111111' }};
}
.upload-zone {
    border-color: var(--portal-color);
}
.upload-zone.dragover {
    background-color: color-mix(in srgb, var(--portal-color) 5%, white);
}
</style>

<script>
const PORTAL_SLUG = '{{ portal.slug }}';
const MAX_FILE_SIZE = {{ portal.max_file_size }};
const MAX_FILES = {{ portal.max_files }};
const REQUIRE_EMAIL = {{ portal.require_email|yesno:"true,false" }};
const REQUIRE_NAME = {{ portal.require_name|yesno:"true,false" }};
const ALLOWED_EXTENSIONS = {{ portal.get_allowed_extensions_list|safe }};

let files = [];
let transferId = null;

// Elements
const uploadZone = document.getElementById('upload-zone');
const fileInput = document.getElementById('file-input');
const fileList = document.getElementById('file-list');
const filesContainer = document.getElementById('files-container');
const fileCountEl = document.getElementById('file-count');
const totalSizeEl = document.getElementById('total-size');
const infoSection = document.getElementById('info-section');
const uploadButtonSection = document.getElementById('upload-button-section');
const uploadBtn = document.getElementById('upload-btn');
const progressSection = document.getElementById('progress-section');
const uploadProgress = document.getElementById('upload-progress');
const uploadStatus = document.getElementById('upload-status');
const successSection = document.getElementById('success-section');

// Drag and drop
uploadZone.addEventListener('click', () => fileInput.click());
uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragover');
});
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    addFiles(e.dataTransfer.files);
});
fileInput.addEventListener('change', (e) => addFiles(e.target.files));

function addFiles(newFiles) {
    for (let file of newFiles) {
        if (files.find(f => f.name === file.name && f.size === file.size)) continue;
        if (file.size > MAX_FILE_SIZE) {
            alert(`File "${file.name}" exceeds the maximum size limit.`);
            continue;
        }
        if (ALLOWED_EXTENSIONS.length > 0) {
            const ext = file.name.split('.').pop().toLowerCase();
            if (!ALLOWED_EXTENSIONS.includes(ext)) {
                alert(`File type ".${ext}" is not allowed.`);
                continue;
            }
        }
        if (files.length >= MAX_FILES) {
            alert(`Maximum ${MAX_FILES} files allowed.`);
            break;
        }
        files.push(file);
    }
    updateFileList();
}

function updateFileList() {
    if (files.length === 0) {
        fileList.style.display = 'none';
        infoSection.style.display = 'none';
        uploadButtonSection.style.display = 'none';
        return;
    }

    fileList.style.display = 'block';
    infoSection.style.display = 'block';
    uploadButtonSection.style.display = 'block';

    fileCountEl.textContent = `${files.length} file${files.length === 1 ? '' : 's'}`;
    totalSizeEl.textContent = formatSize(getTotalSize());

    filesContainer.innerHTML = '';
    files.forEach((file, index) => {
        const div = document.createElement('div');
        div.className = 'file-item';
        div.innerHTML = `
            <span class="file-name">${escapeHtml(file.name)}</span>
            <span class="file-size">${formatSize(file.size)}</span>
            <button type="button" class="btn btn-sm ms-3" onclick="removeFile(${index})" style="color: var(--gray-400);">&times;</button>
        `;
        filesContainer.appendChild(div);
    });
}

function removeFile(index) {
    files.splice(index, 1);
    updateFileList();
}

function getTotalSize() {
    return files.reduce((sum, f) => sum + f.size, 0);
}

function formatSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCsrfToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

uploadBtn.addEventListener('click', async () => {
    if (files.length === 0) return;

    // Validate required fields
    const email = document.getElementById('uploader-email').value.trim();
    const name = document.getElementById('uploader-name')?.value.trim() || '';
    const message = document.getElementById('message').value.trim();

    if (REQUIRE_EMAIL && !email) {
        alert('Email is required');
        return;
    }
    if (REQUIRE_NAME && !name) {
        alert('Name is required');
        return;
    }

    // Disable UI
    uploadBtn.disabled = true;
    uploadZone.style.pointerEvents = 'none';
    progressSection.style.display = 'block';
    uploadButtonSection.style.display = 'none';
    infoSection.style.display = 'none';

    try {
        // Create portal upload
        const createResponse = await fetch(`/api/portals/${PORTAL_SLUG}/upload/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
            },
            body: JSON.stringify({
                email: email,
                name: name,
                message: message,
            }),
        });

        if (!createResponse.ok) {
            const err = await createResponse.json();
            throw new Error(err.error || 'Failed to start upload');
        }

        const createData = await createResponse.json();
        transferId = createData.transfer_id;

        // Upload files
        const totalSize = getTotalSize();
        let totalUploaded = 0;

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            uploadStatus.textContent = `Uploading ${i + 1}/${files.length}: ${file.name}`;

            const formData = new FormData();
            formData.append('file', file);

            const uploadResponse = await fetch(`/api/transfers/${transferId}/upload/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': getCsrfToken() },
                body: formData,
            });

            if (!uploadResponse.ok) throw new Error(`Failed to upload ${file.name}`);

            totalUploaded += file.size;
            uploadProgress.style.width = `${Math.round((totalUploaded / totalSize) * 100)}%`;
        }

        // Finalize
        uploadStatus.textContent = 'Finalizing...';
        const finalizeResponse = await fetch(`/api/portals/${PORTAL_SLUG}/finalize/${transferId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
            },
        });

        if (!finalizeResponse.ok) throw new Error('Failed to finalize upload');

        // Success
        progressSection.style.display = 'none';
        successSection.style.display = 'block';
        uploadZone.style.display = 'none';
        fileList.style.display = 'none';

    } catch (error) {
        console.error('Upload error:', error);
        uploadStatus.textContent = 'Upload failed: ' + error.message;
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'RETRY';
        uploadButtonSection.style.display = 'block';
    }
});

function resetUpload() {
    files = [];
    transferId = null;
    updateFileList();
    uploadZone.style.display = 'block';
    uploadZone.style.pointerEvents = 'auto';
    successSection.style.display = 'none';
    progressSection.style.display = 'none';
    uploadBtn.disabled = false;
    uploadBtn.textContent = 'UPLOAD FILES';
    uploadProgress.style.width = '0%';
    document.getElementById('uploader-email').value = '';
    if (document.getElementById('uploader-name')) document.getElementById('uploader-name').value = '';
    document.getElementById('message').value = '';
}
</script>
{% endblock %}
