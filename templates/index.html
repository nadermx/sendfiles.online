{% extends "base.html" %}
{% load static %}

{% block title %}SendFiles.Online - Send Large Files Free | Up to 3GB{% endblock %}
{% block description %}Send large files up to 3GB for free. No signup required. Fast, simple, secure file sharing with 7-day storage. The easiest way to share files online.{% endblock %}
{% block og_title %}SendFiles.Online - Send Large Files Free | Up to 3GB{% endblock %}
{% block og_description %}Send large files up to 3GB for free. No signup required. Fast, simple, secure file sharing.{% endblock %}
{% block twitter_title %}SendFiles.Online - Send Large Files Free{% endblock %}
{% block twitter_description %}Send large files up to 3GB for free. No signup required. Fast, secure file sharing.{% endblock %}
{% block canonical_path %}/{% endblock %}

{% block extra_head %}
<!-- Uppy CSS -->
<link href="https://releases.transloadit.com/uppy/v3.27.0/uppy.min.css" rel="stylesheet">
<style>
/* Uppy customization to match our industrial design */
.uppy-Dashboard-inner {
    border-radius: 0 !important;
    border: 2px dashed var(--gray-300) !important;
    background: var(--gray-50) !important;
    max-width: 600px !important;
    margin: 0 auto !important;
}
.uppy-Dashboard-AddFiles {
    border: none !important;
}
.uppy-Dashboard-AddFiles-title {
    font-family: 'Inter', sans-serif !important;
    text-transform: uppercase !important;
    letter-spacing: 0.05em !important;
}
.uppy-Dashboard-browse {
    color: var(--gray-900) !important;
    text-decoration: underline !important;
    font-weight: 600 !important;
}
.uppy-Dashboard-browse:hover {
    color: var(--gray-600) !important;
}
.uppy-StatusBar {
    border-radius: 0 !important;
    max-width: 600px !important;
    margin: 0 auto !important;
}
.uppy-StatusBar-actionBtn--upload {
    border-radius: 0 !important;
    background: var(--gray-900) !important;
}
.uppy-StatusBar-actionBtn--upload:hover {
    background: var(--gray-700) !important;
}
.uppy-DashboardContent-bar {
    border-radius: 0 !important;
}
.uppy-Dashboard-Item {
    border-radius: 0 !important;
}
.uppy-Dashboard-Item-previewImg {
    border-radius: 0 !important;
}
.uppy-StatusBar-progress {
    background: var(--gray-900) !important;
}
</style>
{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "SendFiles.Online",
    "url": "https://sendfiles.online",
    "applicationCategory": "FileTransfer",
    "operatingSystem": "Any",
    "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
    },
    "featureList": [
        "Send files up to 3GB",
        "No signup required",
        "7-day file storage",
        "Password protection",
        "File encryption"
    ]
}
</script>
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": [
        {
            "@type": "Question",
            "name": "How large of files can I send?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "You can send files up to 3GB for free with SendFiles.Online. No signup is required for basic transfers."
            }
        },
        {
            "@type": "Question",
            "name": "How long are files stored?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "Free transfers are stored for 7 days. Premium plans offer extended storage up to 365 days."
            }
        },
        {
            "@type": "Question",
            "name": "Do I need to create an account?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "No, you can send files without creating an account. Simply drag and drop your files and share the link."
            }
        },
        {
            "@type": "Question",
            "name": "Are my files secure?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "Yes. All transfers use HTTPS encryption. You can also add password protection and enable file encryption for additional security."
            }
        },
        {
            "@type": "Question",
            "name": "How do recipients download files?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "Recipients receive a unique download link. They can download individual files or all files as a ZIP archive with one click."
            }
        }
    ]
}
</script>
{% endblock %}

{% block content %}
<div class="hero">
    <div class="container">
        <h1>SEND FILES. FAST.</h1>
        <p class="subtitle">Up to 3GB free. No signup required.</p>
    </div>
</div>

<div class="container pb-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Uppy Dashboard -->
            <div id="uppy-dashboard"></div>

            <!-- Transfer Options -->
            <div id="options-section" class="mt-4">
                <!-- Team Selector (Business/Enterprise only) -->
                {% if user_teams %}
                <div class="options-grid mb-3">
                    <div class="option-group">
                        <label class="option-label">Assign to Team</label>
                        <select id="team-select" class="form-select form-select-sm">
                            <option value="">Personal Transfer</option>
                            {% for team in user_teams %}
                            <option value="{{ team.id }}">{{ team.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="option-group" id="visibility-group" style="display: none;">
                        <label class="option-label">Visibility</label>
                        <select id="visibility-select" class="form-select form-select-sm">
                            <option value="private">Private (only you)</option>
                            <option value="team" selected>Team (all members)</option>
                            <option value="public">Public (anyone with link)</option>
                        </select>
                    </div>
                </div>
                {% endif %}

                <!-- Expiration & Limits Row -->
                <div class="options-grid mb-3">
                    <div class="option-group">
                        <label class="option-label">Expires after</label>
                        <select id="expiration-select" class="form-select form-select-sm">
                            <option value="1">1 day</option>
                            <option value="3">3 days</option>
                            <option value="7" selected>7 days</option>
                            <option value="14">14 days (Pro)</option>
                            <option value="30">30 days (Pro)</option>
                        </select>
                    </div>
                    <div class="option-group">
                        <label class="option-label">Download limit</label>
                        <select id="download-limit-select" class="form-select form-select-sm">
                            <option value="">Unlimited</option>
                            <option value="1">1 download</option>
                            <option value="5">5 downloads</option>
                            <option value="10">10 downloads</option>
                            <option value="25">25 downloads</option>
                            <option value="50">50 downloads</option>
                            <option value="100">100 downloads</option>
                        </select>
                    </div>
                </div>
                <!-- Checkboxes Row -->
                <div class="options-row mb-3">
                    <label class="option-checkbox">
                        <input type="checkbox" id="password-option">
                        Password protect
                    </label>
                    <label class="option-checkbox">
                        <input type="checkbox" id="encrypt-option">
                        Encrypt files
                    </label>
                    <label class="option-checkbox">
                        <input type="checkbox" id="notify-option">
                        Notify me when downloaded
                    </label>
                    <label class="option-checkbox">
                        <input type="checkbox" id="auto-delete-option">
                        Auto-delete after first download
                    </label>
                </div>
                <!-- Advanced Security Row (collapsed by default) -->
                <div class="mb-0">
                    <a class="small text-muted" data-bs-toggle="collapse" href="#security-options" role="button" aria-expanded="false">
                        <i class="fas fa-shield-alt me-1"></i> Advanced security options
                    </a>
                    <div class="collapse mt-3" id="security-options">
                        <div class="card">
                            <div class="card-body">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="require-email-verification">
                                    <label class="form-check-label small" for="require-email-verification">
                                        Require email verification to download
                                    </label>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label small text-muted mb-1">Restrict to email domains (comma-separated)</label>
                                    <input type="text" class="form-control form-control-sm" id="allowed-domains" placeholder="company.com, partner.org">
                                </div>
                                <div class="mb-0">
                                    <label class="form-label small text-muted mb-1">Restrict to IP addresses (comma-separated)</label>
                                    <input type="text" class="form-control form-control-sm" id="allowed-ips" placeholder="192.168.1.1, 10.0.0.0">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Password Input (hidden initially) -->
            <div id="password-section" class="mt-3" style="display: none;">
                <input type="password" id="password-input" class="form-control" placeholder="Enter password" style="max-width: 300px; border-radius: 0;">
            </div>

            <!-- Email Options -->
            <div id="email-section" class="mt-4">
                <div class="row g-3">
                    <div class="col-md-6">
                        <input type="email" id="sender-email" class="form-control" placeholder="Your email (optional)" style="border-radius: 0;">
                    </div>
                    <div class="col-md-6">
                        <input type="email" id="recipient-email" class="form-control" placeholder="Recipient email (optional)" style="border-radius: 0;">
                    </div>
                </div>
                <div class="mt-3">
                    <textarea id="message-input" class="form-control" rows="2" placeholder="Add a message (optional)" style="border-radius: 0;"></textarea>
                </div>
            </div>

            <!-- FAQ Section -->
            <div class="faq-section">
                <h2>Frequently Asked Questions</h2>
                <div class="faq-item">
                    <div class="faq-question">How large of files can I send?</div>
                    <div class="faq-answer">You can send files up to 3GB for free with SendFiles.Online. No signup is required for basic transfers.</div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">How long are files stored?</div>
                    <div class="faq-answer">Free transfers are stored for 7 days. Premium plans offer extended storage up to 365 days.</div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">Do I need to create an account?</div>
                    <div class="faq-answer">No, you can send files without creating an account. Simply drag and drop your files and share the link.</div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">Are my files secure?</div>
                    <div class="faq-answer">Yes. All transfers use HTTPS encryption. You can also add password protection and enable file encryption for additional security.</div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">How do recipients download files?</div>
                    <div class="faq-answer">Recipients receive a unique download link. They can download individual files or all files as a ZIP archive with one click.</div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if not is_pro %}
<div class="quota-bar mb-4">
    <div class="container">
        <div class="quota-info">
            <span class="quota-label">Monthly quota:</span>
            <span class="quota-value">{{ monthly_remaining|filesizeformat }} remaining</span>
            <div class="quota-progress">
                <div class="quota-progress-bar" style="width: {% widthratio monthly_used monthly_limit 100 %}%;"></div>
            </div>
            <a href="{% url 'pricing' %}" class="quota-upgrade">Upgrade for unlimited</a>
        </div>
    </div>
</div>
{% endif %}

<div class="feature-bar">
    <span>No signup</span>
    <span>Free forever</span>
    <span>7-day storage</span>
    <span>{% if is_pro %}Unlimited{% else %}3GB/month{% endif %}</span>
</div>
{% endblock %}

{% block scripts %}
<!-- Uppy JS -->
<script src="https://releases.transloadit.com/uppy/v3.27.0/uppy.min.js"></script>
<script>
const MAX_SIZE = {{ max_size }};
let transferId = null;
let uppy = null;

// Get CSRF token
function getCsrfToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Get transfer options from form
function getTransferOptions() {
    const expirationDays = parseInt(document.getElementById('expiration-select').value);
    const downloadLimit = document.getElementById('download-limit-select').value;
    const autoDelete = document.getElementById('auto-delete-option').checked;
    const notifyOnDownload = document.getElementById('notify-option').checked;
    const requireEmailVerification = document.getElementById('require-email-verification').checked;
    const allowedDomains = document.getElementById('allowed-domains').value.trim();
    const allowedIps = document.getElementById('allowed-ips').value.trim();
    const passwordOption = document.getElementById('password-option');
    const passwordInput = document.getElementById('password-input');

    const teamSelectEl = document.getElementById('team-select');
    const visibilitySelectEl = document.getElementById('visibility-select');
    const teamId = teamSelectEl ? teamSelectEl.value : '';
    const visibility = visibilitySelectEl && teamId ? visibilitySelectEl.value : 'private';

    return {
        sender_email: document.getElementById('sender-email').value,
        recipients: document.getElementById('recipient-email').value,
        message: document.getElementById('message-input').value,
        password: passwordOption.checked ? passwordInput.value : '',
        encryption: document.getElementById('encrypt-option').checked ? 'server' : 'none',
        expiration_days: expirationDays,
        max_downloads: autoDelete ? 1 : (downloadLimit ? parseInt(downloadLimit) : null),
        notify_on_download: notifyOnDownload,
        require_email_verification: requireEmailVerification,
        allowed_domains: allowedDomains,
        allowed_ips: allowedIps,
        team_id: teamId || null,
        visibility: visibility,
    };
}

// Create transfer and return transfer ID
async function createTransfer() {
    const options = getTransferOptions();
    const response = await fetch('/api/transfers/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
        },
        body: JSON.stringify(options),
    });

    if (!response.ok) {
        throw new Error('Failed to create transfer');
    }

    const data = await response.json();
    return data.transfer_id;
}

// Finalize transfer
async function finalizeTransfer(transferId) {
    const response = await fetch(`/api/transfers/${transferId}/finalize/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken(),
        },
    });

    if (!response.ok) {
        throw new Error('Failed to finalize transfer');
    }

    return await response.json();
}

// Initialize Uppy
document.addEventListener('DOMContentLoaded', function() {
    const { Uppy, Dashboard, Tus } = window.Uppy;

    uppy = new Uppy({
        restrictions: {
            maxTotalFileSize: MAX_SIZE,
        },
        autoProceed: false,
        locale: {
            strings: {
                dropPasteFiles: 'Drop files here or %{browse}',
                browse: 'click to browse',
                uploadXFiles: {
                    '0': 'Send %{smart_count} file',
                    '1': 'Send %{smart_count} files',
                },
                uploadXNewFiles: {
                    '0': 'Send +%{smart_count} file',
                    '1': 'Send +%{smart_count} files',
                },
            },
        },
    })
    .use(Dashboard, {
        target: '#uppy-dashboard',
        inline: true,
        height: 350,
        width: '100%',
        showProgressDetails: true,
        showRemoveButtonAfterComplete: true,
        note: `Maximum {{ max_size_gb|floatformat:0 }}GB per transfer. Resumable uploads - safe to resume if connection drops.`,
        proudlyDisplayPoweredByUppy: false,
        locale: {
            strings: {
                dropPasteFiles: 'DROP FILES HERE OR %{browse}',
                browse: 'CLICK TO BROWSE',
            },
        },
    })
    .use(Tus, {
        endpoint: '/api/tus/placeholder/',  // Will be updated before upload
        retryDelays: [0, 1000, 3000, 5000],
        chunkSize: 5 * 1024 * 1024,  // 5MB chunks
        headers: () => ({
            'X-CSRFToken': getCsrfToken(),
        }),
    });

    // Add pre-processor to create transfer before upload starts
    uppy.addPreProcessor(async (fileIDs) => {
        if (!transferId && fileIDs.length > 0) {
            try {
                transferId = await createTransfer();
                // Update tus endpoint with the new transfer ID
                const tusPlugin = uppy.getPlugin('Tus');
                tusPlugin.setOptions({
                    endpoint: `/api/tus/${transferId}/`,
                });
                console.log('Transfer created:', transferId);
            } catch (error) {
                console.error('Failed to create transfer:', error);
                uppy.info('Failed to start upload. Please try again.', 'error', 5000);
                throw new Error('Failed to create transfer');
            }
        }
        return fileIDs;
    });

    // Handle upload complete
    uppy.on('complete', async (result) => {
        if (result.successful.length > 0 && transferId) {
            try {
                const finalizeData = await finalizeTransfer(transferId);
                window.location.href = `/sent/${finalizeData.short_id}/`;
            } catch (error) {
                console.error('Finalize error:', error);
                uppy.info('Failed to finalize transfer. Please try again.', 'error', 5000);
            }
        }
    });

    // Handle errors
    uppy.on('error', (error) => {
        console.error('Upload error:', error);
    });

    // Reset transfer ID when all files are removed
    uppy.on('file-removed', () => {
        if (uppy.getFiles().length === 0) {
            transferId = null;
        }
    });

    // Cancel upload and reset
    uppy.on('cancel-all', () => {
        transferId = null;
    });

    // Password option toggle
    const passwordOption = document.getElementById('password-option');
    const passwordSection = document.getElementById('password-section');
    passwordOption.addEventListener('change', () => {
        passwordSection.style.display = passwordOption.checked ? 'block' : 'none';
    });

    // Team selector toggle (for visibility options)
    const teamSelect = document.getElementById('team-select');
    const visibilityGroup = document.getElementById('visibility-group');
    if (teamSelect && visibilityGroup) {
        teamSelect.addEventListener('change', () => {
            visibilityGroup.style.display = teamSelect.value ? 'block' : 'none';
        });
    }

    // Auto-delete option toggle
    const autoDeleteOption = document.getElementById('auto-delete-option');
    const downloadLimitSelect = document.getElementById('download-limit-select');
    autoDeleteOption.addEventListener('change', () => {
        if (autoDeleteOption.checked) {
            downloadLimitSelect.value = '1';
            downloadLimitSelect.disabled = true;
        } else {
            downloadLimitSelect.disabled = false;
        }
    });
});
</script>
{% endblock %}
