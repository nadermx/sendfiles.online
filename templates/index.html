{% extends "base.html" %}
{% load static %}

{% block title %}SendFiles.Online - Send Large Files Free | Up to 3GB{% endblock %}
{% block description %}Send large files up to 3GB for free. No signup required. Fast, simple, secure file sharing with 7-day storage. The easiest way to share files online.{% endblock %}
{% block og_title %}SendFiles.Online - Send Large Files Free | Up to 3GB{% endblock %}
{% block og_description %}Send large files up to 3GB for free. No signup required. Fast, simple, secure file sharing.{% endblock %}
{% block twitter_title %}SendFiles.Online - Send Large Files Free{% endblock %}
{% block twitter_description %}Send large files up to 3GB for free. No signup required. Fast, secure file sharing.{% endblock %}
{% block canonical_path %}/{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "SendFiles.Online",
    "url": "https://sendfiles.online",
    "applicationCategory": "FileTransfer",
    "operatingSystem": "Any",
    "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
    },
    "featureList": [
        "Send files up to 3GB",
        "No signup required",
        "7-day file storage",
        "Password protection",
        "File encryption"
    ]
}
</script>
<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": [
        {
            "@type": "Question",
            "name": "How large of files can I send?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "You can send files up to 3GB for free with SendFiles.Online. No signup is required for basic transfers."
            }
        },
        {
            "@type": "Question",
            "name": "How long are files stored?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "Free transfers are stored for 7 days. Premium plans offer extended storage up to 365 days."
            }
        },
        {
            "@type": "Question",
            "name": "Do I need to create an account?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "No, you can send files without creating an account. Simply drag and drop your files and share the link."
            }
        },
        {
            "@type": "Question",
            "name": "Are my files secure?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "Yes. All transfers use HTTPS encryption. You can also add password protection and enable file encryption for additional security."
            }
        },
        {
            "@type": "Question",
            "name": "How do recipients download files?",
            "acceptedAnswer": {
                "@type": "Answer",
                "text": "Recipients receive a unique download link. They can download individual files or all files as a ZIP archive with one click."
            }
        }
    ]
}
</script>
{% endblock %}

{% block content %}
<div class="hero">
    <div class="container">
        <h1>SEND FILES. FAST.</h1>
        <p class="subtitle">Up to 3GB free. No signup required.</p>
    </div>
</div>

<div class="container pb-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Upload Zone -->
            <div id="upload-zone" class="upload-zone">
                <h2>DROP FILES HERE OR CLICK TO BROWSE</h2>
                <p>Maximum {{ max_size_gb|floatformat:0 }}GB per transfer</p>
                <input type="file" id="file-input" multiple style="display: none;">
            </div>

            <!-- File List (hidden initially) -->
            <div id="file-list" class="mt-4" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span id="file-count" class="font-mono">0 files</span>
                    <span id="total-size" class="font-mono text-muted">0 KB</span>
                </div>
                <div id="files-container"></div>
            </div>

            <!-- Transfer Options -->
            <div id="options-section" style="display: none;">
                <!-- Team Selector (Business/Enterprise only) -->
                {% if user_teams %}
                <div class="options-grid mb-3">
                    <div class="option-group">
                        <label class="option-label">Assign to Team</label>
                        <select id="team-select" class="form-select form-select-sm">
                            <option value="">Personal Transfer</option>
                            {% for team in user_teams %}
                            <option value="{{ team.id }}">{{ team.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="option-group" id="visibility-group" style="display: none;">
                        <label class="option-label">Visibility</label>
                        <select id="visibility-select" class="form-select form-select-sm">
                            <option value="private">Private (only you)</option>
                            <option value="team" selected>Team (all members)</option>
                            <option value="public">Public (anyone with link)</option>
                        </select>
                    </div>
                </div>
                {% endif %}

                <!-- Expiration & Limits Row -->
                <div class="options-grid mb-3">
                    <div class="option-group">
                        <label class="option-label">Expires after</label>
                        <select id="expiration-select" class="form-select form-select-sm">
                            <option value="1">1 day</option>
                            <option value="3">3 days</option>
                            <option value="7" selected>7 days</option>
                            <option value="14">14 days (Pro)</option>
                            <option value="30">30 days (Pro)</option>
                        </select>
                    </div>
                    <div class="option-group">
                        <label class="option-label">Download limit</label>
                        <select id="download-limit-select" class="form-select form-select-sm">
                            <option value="">Unlimited</option>
                            <option value="1">1 download</option>
                            <option value="5">5 downloads</option>
                            <option value="10">10 downloads</option>
                            <option value="25">25 downloads</option>
                            <option value="50">50 downloads</option>
                            <option value="100">100 downloads</option>
                        </select>
                    </div>
                </div>
                <!-- Checkboxes Row -->
                <div class="options-row mb-3">
                    <label class="option-checkbox">
                        <input type="checkbox" id="password-option">
                        Password protect
                    </label>
                    <label class="option-checkbox">
                        <input type="checkbox" id="encrypt-option">
                        Encrypt files
                    </label>
                    <label class="option-checkbox">
                        <input type="checkbox" id="notify-option">
                        Notify me when downloaded
                    </label>
                    <label class="option-checkbox">
                        <input type="checkbox" id="auto-delete-option">
                        Auto-delete after first download
                    </label>
                </div>
                <!-- Advanced Security Row (collapsed by default) -->
                <div class="mb-0">
                    <a class="small text-muted" data-bs-toggle="collapse" href="#security-options" role="button" aria-expanded="false">
                        <i class="fas fa-shield-alt me-1"></i> Advanced security options
                    </a>
                    <div class="collapse mt-3" id="security-options">
                        <div class="card">
                            <div class="card-body">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="require-email-verification">
                                    <label class="form-check-label small" for="require-email-verification">
                                        Require email verification to download
                                    </label>
                                </div>
                                <div class="mb-2">
                                    <label class="form-label small text-muted mb-1">Restrict to email domains (comma-separated)</label>
                                    <input type="text" class="form-control form-control-sm" id="allowed-domains" placeholder="company.com, partner.org">
                                </div>
                                <div class="mb-0">
                                    <label class="form-label small text-muted mb-1">Restrict to IP addresses (comma-separated)</label>
                                    <input type="text" class="form-control form-control-sm" id="allowed-ips" placeholder="192.168.1.1, 10.0.0.0">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Password Input (hidden initially) -->
            <div id="password-section" class="mt-3" style="display: none;">
                <input type="password" id="password-input" class="form-control" placeholder="Enter password" style="max-width: 300px; border-radius: 0;">
            </div>

            <!-- Email Options (hidden initially) -->
            <div id="email-section" class="mt-4" style="display: none;">
                <div class="row g-3">
                    <div class="col-md-6">
                        <input type="email" id="sender-email" class="form-control" placeholder="Your email (optional)" style="border-radius: 0;">
                    </div>
                    <div class="col-md-6">
                        <input type="email" id="recipient-email" class="form-control" placeholder="Recipient email (optional)" style="border-radius: 0;">
                    </div>
                </div>
                <div class="mt-3">
                    <textarea id="message-input" class="form-control" rows="2" placeholder="Add a message (optional)" style="border-radius: 0;"></textarea>
                </div>
            </div>

            <!-- Upload Button -->
            <div id="upload-button-section" class="mt-4 text-center" style="display: none;">
                <button id="upload-btn" class="btn btn-primary btn-lg">
                    SEND FILES
                </button>
            </div>

            <!-- Progress Section (hidden initially) -->
            <div id="progress-section" class="mt-4" style="display: none;">
                <div class="text-center mb-3">
                    <span id="upload-status" class="font-mono">Uploading...</span>
                </div>
                <div class="progress">
                    <div id="upload-progress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <span id="upload-speed" class="font-mono small text-muted">0 MB/s</span>
                    <span id="upload-eta" class="font-mono small text-muted">ETA: calculating...</span>
                </div>
            </div>

            <!-- FAQ Section -->
            <div class="faq-section">
                <h2>Frequently Asked Questions</h2>
                <div class="faq-item">
                    <div class="faq-question">How large of files can I send?</div>
                    <div class="faq-answer">You can send files up to 3GB for free with SendFiles.Online. No signup is required for basic transfers.</div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">How long are files stored?</div>
                    <div class="faq-answer">Free transfers are stored for 7 days. Premium plans offer extended storage up to 365 days.</div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">Do I need to create an account?</div>
                    <div class="faq-answer">No, you can send files without creating an account. Simply drag and drop your files and share the link.</div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">Are my files secure?</div>
                    <div class="faq-answer">Yes. All transfers use HTTPS encryption. You can also add password protection and enable file encryption for additional security.</div>
                </div>
                <div class="faq-item">
                    <div class="faq-question">How do recipients download files?</div>
                    <div class="faq-answer">Recipients receive a unique download link. They can download individual files or all files as a ZIP archive with one click.</div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if not is_pro %}
<div class="quota-bar mb-4">
    <div class="container">
        <div class="quota-info">
            <span class="quota-label">Monthly quota:</span>
            <span class="quota-value">{{ monthly_remaining|filesizeformat }} remaining</span>
            <div class="quota-progress">
                <div class="quota-progress-bar" style="width: {% widthratio monthly_used monthly_limit 100 %}%;"></div>
            </div>
            <a href="{% url 'pricing' %}" class="quota-upgrade">Upgrade for unlimited</a>
        </div>
    </div>
</div>
{% endif %}

<div class="feature-bar">
    <span>No signup</span>
    <span>Free forever</span>
    <span>7-day storage</span>
    <span>{% if is_pro %}Unlimited{% else %}3GB/month{% endif %}</span>
</div>
{% endblock %}

{% block scripts %}
<script>
const MAX_SIZE = {{ max_size }};
let files = [];
let transferId = null;
let uploadStartTime = null;
let totalUploaded = 0;

// Elements
const uploadZone = document.getElementById('upload-zone');
const fileInput = document.getElementById('file-input');
const fileList = document.getElementById('file-list');
const filesContainer = document.getElementById('files-container');
const fileCountEl = document.getElementById('file-count');
const totalSizeEl = document.getElementById('total-size');
const optionsSection = document.getElementById('options-section');
const emailSection = document.getElementById('email-section');
const uploadButtonSection = document.getElementById('upload-button-section');
const uploadBtn = document.getElementById('upload-btn');
const progressSection = document.getElementById('progress-section');
const uploadProgress = document.getElementById('upload-progress');
const uploadStatus = document.getElementById('upload-status');
const uploadSpeed = document.getElementById('upload-speed');
const uploadEta = document.getElementById('upload-eta');
const passwordOption = document.getElementById('password-option');
const passwordSection = document.getElementById('password-section');
const passwordInput = document.getElementById('password-input');

// Drag and drop
uploadZone.addEventListener('click', () => fileInput.click());

uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragover');
});

uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragover');
});

uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    addFiles(e.dataTransfer.files);
});

fileInput.addEventListener('change', (e) => {
    addFiles(e.target.files);
});

// Password option toggle
passwordOption.addEventListener('change', () => {
    passwordSection.style.display = passwordOption.checked ? 'block' : 'none';
});

// Team selector toggle (for visibility options)
const teamSelect = document.getElementById('team-select');
const visibilityGroup = document.getElementById('visibility-group');
if (teamSelect && visibilityGroup) {
    teamSelect.addEventListener('change', () => {
        visibilityGroup.style.display = teamSelect.value ? 'block' : 'none';
    });
}

// Auto-delete option toggle
const autoDeleteOption = document.getElementById('auto-delete-option');
const downloadLimitSelect = document.getElementById('download-limit-select');
autoDeleteOption.addEventListener('change', () => {
    if (autoDeleteOption.checked) {
        downloadLimitSelect.value = '1';
        downloadLimitSelect.disabled = true;
    } else {
        downloadLimitSelect.disabled = false;
    }
});

// Add files
function addFiles(newFiles) {
    for (let file of newFiles) {
        // Check if file already added
        if (files.find(f => f.name === file.name && f.size === file.size)) {
            continue;
        }
        files.push(file);
    }
    updateFileList();
}

// Update file list display
function updateFileList() {
    if (files.length === 0) {
        fileList.style.display = 'none';
        optionsSection.style.display = 'none';
        emailSection.style.display = 'none';
        uploadButtonSection.style.display = 'none';
        return;
    }

    fileList.style.display = 'block';
    optionsSection.style.display = 'flex';
    emailSection.style.display = 'block';
    uploadButtonSection.style.display = 'block';

    // Update count and size
    fileCountEl.textContent = `${files.length} file${files.length === 1 ? '' : 's'}`;
    totalSizeEl.textContent = formatSize(getTotalSize());

    // Render file list
    filesContainer.innerHTML = '';
    files.forEach((file, index) => {
        const div = document.createElement('div');
        div.className = 'file-item';
        div.innerHTML = `
            <span class="file-name">${escapeHtml(file.name)}</span>
            <span class="file-size">${formatSize(file.size)}</span>
            <button type="button" class="btn btn-sm ms-3" onclick="removeFile(${index})" style="color: var(--gray-400);">&times;</button>
        `;
        filesContainer.appendChild(div);
    });

    // Check size limit
    if (getTotalSize() > MAX_SIZE) {
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'SIZE LIMIT EXCEEDED';
    } else {
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'SEND FILES';
    }
}

// Remove file
function removeFile(index) {
    files.splice(index, 1);
    updateFileList();
}

// Get total size
function getTotalSize() {
    return files.reduce((sum, f) => sum + f.size, 0);
}

// Format size
function formatSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// Escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Get CSRF token
function getCsrfToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Upload button click
uploadBtn.addEventListener('click', async () => {
    if (files.length === 0) return;

    // Disable UI
    uploadBtn.disabled = true;
    uploadZone.style.pointerEvents = 'none';
    progressSection.style.display = 'block';
    uploadButtonSection.style.display = 'none';

    try {
        // Get options
        const expirationDays = parseInt(document.getElementById('expiration-select').value);
        const downloadLimit = document.getElementById('download-limit-select').value;
        const autoDelete = document.getElementById('auto-delete-option').checked;
        const notifyOnDownload = document.getElementById('notify-option').checked;

        // Security options
        const requireEmailVerification = document.getElementById('require-email-verification').checked;
        const allowedDomains = document.getElementById('allowed-domains').value.trim();
        const allowedIps = document.getElementById('allowed-ips').value.trim();

        // Team options
        const teamSelectEl = document.getElementById('team-select');
        const visibilitySelectEl = document.getElementById('visibility-select');
        const teamId = teamSelectEl ? teamSelectEl.value : '';
        const visibility = visibilitySelectEl && teamId ? visibilitySelectEl.value : 'private';

        // Create transfer
        const createResponse = await fetch('/api/transfers/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
            },
            body: JSON.stringify({
                sender_email: document.getElementById('sender-email').value,
                recipients: document.getElementById('recipient-email').value,
                message: document.getElementById('message-input').value,
                password: passwordOption.checked ? passwordInput.value : '',
                encryption: document.getElementById('encrypt-option').checked ? 'server' : 'none',
                expiration_days: expirationDays,
                max_downloads: autoDelete ? 1 : (downloadLimit ? parseInt(downloadLimit) : null),
                notify_on_download: notifyOnDownload,
                require_email_verification: requireEmailVerification,
                allowed_domains: allowedDomains,
                allowed_ips: allowedIps,
                team_id: teamId || null,
                visibility: visibility,
            }),
        });

        if (!createResponse.ok) {
            throw new Error('Failed to create transfer');
        }

        const createData = await createResponse.json();
        transferId = createData.transfer_id;

        // Upload files
        uploadStartTime = Date.now();
        totalUploaded = 0;
        const totalSize = getTotalSize();

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            uploadStatus.textContent = `Uploading ${i + 1}/${files.length}: ${file.name}`;

            const formData = new FormData();
            formData.append('file', file);

            const uploadResponse = await fetch(`/api/transfers/${transferId}/upload/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                },
                body: formData,
            });

            if (!uploadResponse.ok) {
                throw new Error(`Failed to upload ${file.name}`);
            }

            totalUploaded += file.size;
            const percent = Math.round((totalUploaded / totalSize) * 100);
            uploadProgress.style.width = `${percent}%`;

            // Calculate speed and ETA
            const elapsed = (Date.now() - uploadStartTime) / 1000;
            const speed = totalUploaded / elapsed;
            const remaining = totalSize - totalUploaded;
            const eta = remaining / speed;

            uploadSpeed.textContent = `${formatSize(speed)}/s`;
            uploadEta.textContent = eta > 0 ? `ETA: ${formatTime(eta)}` : 'Almost done...';
        }

        // Finalize transfer
        uploadStatus.textContent = 'Finalizing...';
        const finalizeResponse = await fetch(`/api/transfers/${transferId}/finalize/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
            },
        });

        if (!finalizeResponse.ok) {
            throw new Error('Failed to finalize transfer');
        }

        const finalizeData = await finalizeResponse.json();

        // Redirect to success page
        window.location.href = `/sent/${finalizeData.short_id}/`;

    } catch (error) {
        console.error('Upload error:', error);
        uploadStatus.textContent = 'Upload failed: ' + error.message;
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'RETRY';
        uploadButtonSection.style.display = 'block';
    }
});

// Format time
function formatTime(seconds) {
    if (seconds < 60) return `${Math.round(seconds)}s`;
    if (seconds < 3600) return `${Math.round(seconds / 60)}m`;
    return `${Math.round(seconds / 3600)}h`;
}
</script>
{% endblock %}
