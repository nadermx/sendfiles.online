{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="hero">
    <div class="container">
        <h1>SEND FILES. FAST.</h1>
        <p class="subtitle">Up to 10GB free. No signup required.</p>
    </div>
</div>

<div class="container pb-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Upload Zone -->
            <div id="upload-zone" class="upload-zone">
                <h2>DROP FILES HERE OR CLICK TO BROWSE</h2>
                <p>Maximum {{ max_size_gb|floatformat:0 }}GB per transfer</p>
                <input type="file" id="file-input" multiple style="display: none;">
            </div>

            <!-- File List (hidden initially) -->
            <div id="file-list" class="mt-4" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span id="file-count" class="font-mono">0 files</span>
                    <span id="total-size" class="font-mono text-muted">0 KB</span>
                </div>
                <div id="files-container"></div>
            </div>

            <!-- Options -->
            <div id="options-section" class="options-row" style="display: none;">
                <label class="option-checkbox">
                    <input type="checkbox" id="password-option">
                    Password protect
                </label>
                <label class="option-checkbox">
                    <input type="checkbox" id="encrypt-option">
                    Encrypt files
                </label>
            </div>

            <!-- Password Input (hidden initially) -->
            <div id="password-section" class="mt-3" style="display: none;">
                <input type="password" id="password-input" class="form-control" placeholder="Enter password" style="max-width: 300px; border-radius: 0;">
            </div>

            <!-- Email Options (hidden initially) -->
            <div id="email-section" class="mt-4" style="display: none;">
                <div class="row g-3">
                    <div class="col-md-6">
                        <input type="email" id="sender-email" class="form-control" placeholder="Your email (optional)" style="border-radius: 0;">
                    </div>
                    <div class="col-md-6">
                        <input type="email" id="recipient-email" class="form-control" placeholder="Recipient email (optional)" style="border-radius: 0;">
                    </div>
                </div>
                <div class="mt-3">
                    <textarea id="message-input" class="form-control" rows="2" placeholder="Add a message (optional)" style="border-radius: 0;"></textarea>
                </div>
            </div>

            <!-- Upload Button -->
            <div id="upload-button-section" class="mt-4 text-center" style="display: none;">
                <button id="upload-btn" class="btn btn-primary btn-lg">
                    SEND FILES
                </button>
            </div>

            <!-- Progress Section (hidden initially) -->
            <div id="progress-section" class="mt-4" style="display: none;">
                <div class="text-center mb-3">
                    <span id="upload-status" class="font-mono">Uploading...</span>
                </div>
                <div class="progress">
                    <div id="upload-progress" class="progress-bar" role="progressbar" style="width: 0%"></div>
                </div>
                <div class="d-flex justify-content-between mt-2">
                    <span id="upload-speed" class="font-mono small text-muted">0 MB/s</span>
                    <span id="upload-eta" class="font-mono small text-muted">ETA: calculating...</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="feature-bar">
    <span>No signup</span>
    <span>Free forever</span>
    <span>14-day storage</span>
    <span>Unlimited transfers</span>
</div>
{% endblock %}

{% block scripts %}
<script>
const MAX_SIZE = {{ max_size }};
let files = [];
let transferId = null;
let uploadStartTime = null;
let totalUploaded = 0;

// Elements
const uploadZone = document.getElementById('upload-zone');
const fileInput = document.getElementById('file-input');
const fileList = document.getElementById('file-list');
const filesContainer = document.getElementById('files-container');
const fileCountEl = document.getElementById('file-count');
const totalSizeEl = document.getElementById('total-size');
const optionsSection = document.getElementById('options-section');
const emailSection = document.getElementById('email-section');
const uploadButtonSection = document.getElementById('upload-button-section');
const uploadBtn = document.getElementById('upload-btn');
const progressSection = document.getElementById('progress-section');
const uploadProgress = document.getElementById('upload-progress');
const uploadStatus = document.getElementById('upload-status');
const uploadSpeed = document.getElementById('upload-speed');
const uploadEta = document.getElementById('upload-eta');
const passwordOption = document.getElementById('password-option');
const passwordSection = document.getElementById('password-section');
const passwordInput = document.getElementById('password-input');

// Drag and drop
uploadZone.addEventListener('click', () => fileInput.click());

uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('dragover');
});

uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('dragover');
});

uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    addFiles(e.dataTransfer.files);
});

fileInput.addEventListener('change', (e) => {
    addFiles(e.target.files);
});

// Password option toggle
passwordOption.addEventListener('change', () => {
    passwordSection.style.display = passwordOption.checked ? 'block' : 'none';
});

// Add files
function addFiles(newFiles) {
    for (let file of newFiles) {
        // Check if file already added
        if (files.find(f => f.name === file.name && f.size === file.size)) {
            continue;
        }
        files.push(file);
    }
    updateFileList();
}

// Update file list display
function updateFileList() {
    if (files.length === 0) {
        fileList.style.display = 'none';
        optionsSection.style.display = 'none';
        emailSection.style.display = 'none';
        uploadButtonSection.style.display = 'none';
        return;
    }

    fileList.style.display = 'block';
    optionsSection.style.display = 'flex';
    emailSection.style.display = 'block';
    uploadButtonSection.style.display = 'block';

    // Update count and size
    fileCountEl.textContent = `${files.length} file${files.length === 1 ? '' : 's'}`;
    totalSizeEl.textContent = formatSize(getTotalSize());

    // Render file list
    filesContainer.innerHTML = '';
    files.forEach((file, index) => {
        const div = document.createElement('div');
        div.className = 'file-item';
        div.innerHTML = `
            <span class="file-name">${escapeHtml(file.name)}</span>
            <span class="file-size">${formatSize(file.size)}</span>
            <button type="button" class="btn btn-sm ms-3" onclick="removeFile(${index})" style="color: var(--gray-400);">&times;</button>
        `;
        filesContainer.appendChild(div);
    });

    // Check size limit
    if (getTotalSize() > MAX_SIZE) {
        uploadBtn.disabled = true;
        uploadBtn.textContent = 'SIZE LIMIT EXCEEDED';
    } else {
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'SEND FILES';
    }
}

// Remove file
function removeFile(index) {
    files.splice(index, 1);
    updateFileList();
}

// Get total size
function getTotalSize() {
    return files.reduce((sum, f) => sum + f.size, 0);
}

// Format size
function formatSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// Escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Get CSRF token
function getCsrfToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Upload button click
uploadBtn.addEventListener('click', async () => {
    if (files.length === 0) return;

    // Disable UI
    uploadBtn.disabled = true;
    uploadZone.style.pointerEvents = 'none';
    progressSection.style.display = 'block';
    uploadButtonSection.style.display = 'none';

    try {
        // Create transfer
        const createResponse = await fetch('/api/transfers/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
            },
            body: JSON.stringify({
                sender_email: document.getElementById('sender-email').value,
                recipients: document.getElementById('recipient-email').value,
                message: document.getElementById('message-input').value,
                password: passwordOption.checked ? passwordInput.value : '',
                encryption: document.getElementById('encrypt-option').checked ? 'server' : 'none',
            }),
        });

        if (!createResponse.ok) {
            throw new Error('Failed to create transfer');
        }

        const createData = await createResponse.json();
        transferId = createData.transfer_id;

        // Upload files
        uploadStartTime = Date.now();
        totalUploaded = 0;
        const totalSize = getTotalSize();

        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            uploadStatus.textContent = `Uploading ${i + 1}/${files.length}: ${file.name}`;

            const formData = new FormData();
            formData.append('file', file);

            const uploadResponse = await fetch(`/api/transfers/${transferId}/upload/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCsrfToken(),
                },
                body: formData,
            });

            if (!uploadResponse.ok) {
                throw new Error(`Failed to upload ${file.name}`);
            }

            totalUploaded += file.size;
            const percent = Math.round((totalUploaded / totalSize) * 100);
            uploadProgress.style.width = `${percent}%`;

            // Calculate speed and ETA
            const elapsed = (Date.now() - uploadStartTime) / 1000;
            const speed = totalUploaded / elapsed;
            const remaining = totalSize - totalUploaded;
            const eta = remaining / speed;

            uploadSpeed.textContent = `${formatSize(speed)}/s`;
            uploadEta.textContent = eta > 0 ? `ETA: ${formatTime(eta)}` : 'Almost done...';
        }

        // Finalize transfer
        uploadStatus.textContent = 'Finalizing...';
        const finalizeResponse = await fetch(`/api/transfers/${transferId}/finalize/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken(),
            },
        });

        if (!finalizeResponse.ok) {
            throw new Error('Failed to finalize transfer');
        }

        const finalizeData = await finalizeResponse.json();

        // Redirect to success page
        window.location.href = `/sent/${finalizeData.short_id}/`;

    } catch (error) {
        console.error('Upload error:', error);
        uploadStatus.textContent = 'Upload failed: ' + error.message;
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'RETRY';
        uploadButtonSection.style.display = 'block';
    }
});

// Format time
function formatTime(seconds) {
    if (seconds < 60) return `${Math.round(seconds)}s`;
    if (seconds < 3600) return `${Math.round(seconds / 60)}m`;
    return `${Math.round(seconds / 3600)}h`;
}
</script>
{% endblock %}
